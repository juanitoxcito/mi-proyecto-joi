name: Android CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: Install build tools for Autoreconf
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential autoconf m4 libtool automake

    - name: Set up Android SDK
      uses: android-actions/setup-android@v3
      with:
        api-level: 29
        build-tools: 30.0.3
        ndk: 25.1.8937393 # Corresponde a NDK 25b

    - name: Install dependencies
      run: |
        pip install buildozer
        pip install setuptools
        pip install cython

    - name: Download and Setup Apache Ant
      run: |
        ANT_VERSION=1.9.4
        ANT_FILE=apache-ant-${ANT_VERSION}-bin.tar.gz
        ANT_URL=https://dlcdn.apache.org/ant/binaries/${ANT_FILE}
        ANT_PATH=${{ github.workspace }}/.buildozer/ant # Ruta relativa a la raíz del repositorio
        
        echo "Downloading Apache Ant from ${ANT_URL}..."
        mkdir -p "${ANT_PATH}"
        curl -L -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/100.0.4896.127 Safari/537.36" -o "${ANT_PATH}/${ANT_FILE}" ${ANT_URL} # ¡Línea de curl modificada!
        
        echo "Extracting Apache Ant..."
        tar -xzf "${ANT_PATH}/${ANT_FILE}" -C "${ANT_PATH}" --strip-components=1
        
        # Limpia el archivo .tar.gz después de la extracción (opcional pero buena práctica)
        rm "${ANT_PATH}/${ANT_FILE}"

    - name: Build Android APK
      run: |
        python -m buildozer android debug
