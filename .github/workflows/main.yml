name: Build Kivy Android APK

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker container
      id: docker_container
      run: |
        docker run -d --name p4a_builder -v "$(pwd):/home/user/app" -w "/home/user/app" kivy/python-for-android sleep infinity
        echo "container_id=$(docker ps -aqf "name=p4a_builder")" >> $GITHUB_OUTPUT

    - name: Configure and build APK
      env:
        FIREBASE_SERVICE_ACCOUNT_JSON: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSON }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      run: |
        docker exec --user $(id -u):$(id -g) ${{ steps.docker_container.outputs.container_id }} bash -c "
          export HOME=/home/user
          # Instala Buildozer y sus dependencias dentro del contenedor
          pip install --user buildozer cython==0.29.36 &&
          
          # A침ade la ruta de instalaci칩n de pip a la variable PATH
          export PATH=\$PATH:\$HOME/.local/bin &&

          # Revisa si buildozer.spec ya existe para evitar errores
          if [ ! -f 'buildozer.spec' ]; then
            ~/.local/bin/buildozer init --no-console
          fi
          
          # Configura los par치metros clave
          sed -i 's/^#*requirements = .*$/requirements = python3,kivy,plyer,networkx,google-generativeai,firebase-admin/' buildozer.spec &&
          sed -i 's/^#*android.api = .*$/android.api = 33/' buildozer.spec &&
          sed -i 's/^#*android.build_tools = .*$/android.build_tools = 33.0.0/' buildozer.spec &&
          sed -i 's/^#*android.ndk = .*$/android.ndk = 25b/' buildozer.spec &&
          
          # Compila la aplicaci칩n para Android
          ~/.local/bin/buildozer android debug --clean
        "
        
    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: joi-android-apk
        path: bin/*.apk

    - name: Clean up Docker container
      if: always()
      run: docker stop ${{ steps.docker_container.outputs.container_id }}
