name: Build Kivy Android APK

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Build Android APK
      env:
        FIREBASE_SERVICE_ACCOUNT_JSON: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSON }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      run: |
        # Este script de shell se ejecuta de forma directa y segura en GitHub Actions.
        # Las variables de entorno ya están disponibles gracias al bloque 'env:'.
        
        # Ejecuta todo el proceso de compilación dentro de un único contenedor Docker.
        # Usa 'kivy/python-for-android'
        docker run --rm \
          -v "$(pwd):/home/user/app" \
          -w "/home/user/app" \
          -e BUILDOZER_ALLOW_ROOT=1 \
          -e FIREBASE_SERVICE_ACCOUNT_JSON="${FIREBASE_SERVICE_ACCOUNT_JSON}" \
          -e GEMINI_API_KEY="${GEMINI_API_KEY}" \
          kivy/python-for-android \
          bash -c "
            # Instala Buildozer y sus dependencias de forma global con permisos de root.
            pip install buildozer cython==0.29.36 networkx google-generativeai firebase-admin || { echo 'Error al instalar paquetes'; exit 1; }
            
            # Crea un nuevo buildozer.spec si no existe.
            if [ ! -f 'buildozer.spec' ]; then
              yes | buildozer init
            fi

            # Modifica los parámetros clave en el archivo buildozer.spec con comandos sed robustos.
            sed -i 's|^#*requirements = .*$|requirements = python3,kivy,plyer,networkx,google-generativeai,firebase-admin|g' buildozer.spec || { echo 'Error al configurar requirements'; exit 1; }
            sed -i 's|^#*android.api = .*$|android.api = 33|g' buildozer.spec || { echo 'Error al configurar android.api'; exit 1; }
            sed -i 's|^#*android.build_tools = .*$|android.build_tools = 33.0.0|g' buildozer.spec || { echo 'Error al configurar android.build_tools'; exit 1; }
            sed -i 's|^#*android.ndk = .*$|android.ndk = 25b|g' buildozer.spec || { echo 'Error al configurar android.ndk'; exit 1; }
            sed -i 's|^#*p4a.python_version = .*$|p4a.python_version = 3|g' buildozer.spec || { echo 'Error al configurar p4a.python_version'; exit 1; }

            # Compila la aplicación para Android
            buildozer android debug --clean || { echo 'Error durante la compilación de Buildozer'; exit 1; }
          "

    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: joi-android-apk
        path: bin/*.apk
