name: Android CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: Install build tools for Autoreconf
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential autoconf m4 libtool automake unzip libtool-bin autoconf-archive # Paquetes actualizados

    - name: Set up Android SDK
      uses: android-actions/setup-android@v3
      with:
        api-level: 29
        build-tools: 30.0.3
        ndk: 25.1.8937393 # Corresponde a NDK 25b

    - name: Install dependencies
      run: |
        pip install buildozer
        pip install setuptools
        pip install cython

    - name: Download and Setup Apache Ant
      run: |
        ANT_VERSION=1.10.15 # ¡VERSION DE ANT ACTUALIZADA!
        ANT_FILE=apache-ant-${ANT_VERSION}-bin.zip
        ANT_URL=https://github.com/juanitoxcito/mi-proyecto-joi/releases/download/ant-files/${ANT_FILE} # ¡TU NUEVA URL DE GITHUB RELEASE!
        ANT_PATH=${{ github.workspace }}/.buildozer/ant
        
        echo "Downloading Apache Ant from ${ANT_URL}..."
        mkdir -p "${ANT_PATH}"
        curl -L -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/100.0.4896.127 Safari/537.36" -o "${ANT_PATH}/${ANT_FILE}" ${ANT_URL}
        
        echo "Extracting Apache Ant..."
        unzip -q "${ANT_PATH}/${ANT_FILE}" -d "${ANT_PATH}"
        mv "${ANT_PATH}/apache-ant-${ANT_VERSION}/"* "${ANT_PATH}/" || true
        rmdir "${ANT_PATH}/apache-ant-${ANT_VERSION}" || true
        
        # Limpia el archivo .zip después de la extracción (opcional pero buena práctica)
        rm "${ANT_PATH}/${ANT_FILE}"

    # Paso actualizado para configurar las macros de libtool
    - name: Configure Libtool Macros
      run: |
        export ACLOCAL_PATH="/usr/share/aclocal" # Indica a aclocal dónde buscar
        aclocal -I /usr/share/aclocal # Ejecuta aclocal explícitamente
        autoreconf -i # Ejecuta autoreconf
        
    - name: Build Android APK
      run: |
        python -m buildozer android debug
